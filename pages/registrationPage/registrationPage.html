<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Rejestracja</title>
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,300"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="./style.css" />
    <link rel="stylesheet" href="../common/htmlStyle.css" />
    <link rel="stylesheet" href="../common/buttonStyle.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
      integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
      crossorigin="anonymous"
    />
  </head>

  <body>
    <div class="buttonsContainer">
      <button class="button btn" onclick="goToLoginPage()">
        <p class="titleOfButton">Logowanie</p>
      </button>
    </div>
    <div class="formContainer">
      <form
        class="loginForm"
        id="form"
        role="form"
        onsubmit="return false"
        autocomplete="off"
      >
        <div class="inputsContainer">
          <div class="labelContainer">
            <label class="label" for="name">Nazwa użytkownika</label>
            <input
              type="text"
              id="name"
              placeholder="Nazwa użytkownika.."
              name="name"
            />
          </div>
          <p id="errorNameField"></p>
          <div class="labelContainer">
            <label class="label" for="password">Hasło</label>
            <input
              type="password"
              id="password"
              placeholder="Hasło.."
              name="password"
            />
          </div>
          <p id="errorPasswordField"></p>
          <div class="labelContainer">
            <label class="label" for="email">Email</label>
            <input type="text" id="email" placeholder="Email.." name="email" />
          </div>
          <p id="errorEmailField"></p>
          <div class="labelContainer">
            <label class="label" for="repeatEmail">Potwierdź email</label>
            <input
              type="text"
              id="repeatEmail"
              placeholder="Potwierdź email.."
              name="repeatEmail"
            />
          </div>
          <p id="errorRepeatEmailField"></p>
          <p id="error"></p>
          <button type="button" class="button btn" onclick="signUp(event)">
            <p class="titleOfButton">Zarejestruj</p>
          </button>
        </div>
      </form>
    </div>

    <script>
      function validateFields() {
        const name = document.getElementById("name").value;
        const nameLength = document.getElementById("name").value.length;
        const validNameCharacters = /^[0-9a-zA-Z]+$/;
        const validEmailCharacters =
          /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;

        const password = document.getElementById("password").value;
        const passwordLength = document.getElementById("password").value.length;

        const email = document.getElementById("email").value;
        const repeatEmail = document.getElementById("repeatEmail").value;
        const error = document.getElementById("error");

        const errorNameField = document.getElementById("errorNameField");
        const errorPasswordField =
          document.getElementById("errorPasswordField");
        const errorEmailField = document.getElementById("errorEmailField");
        const errorRepeatEmailField = document.getElementById(
          "errorRepeatEmailField"
        );

        const errorMessages = {
          name: "Pole nazwa użytkownika nie może być puste!",
          nameLength: "Pole nazwa musi mieć od 6 do 16 znaków!",
          validNameCharacters: "Pole nazwa może zawierać tylko litery i cyfry!",
          password: "Pole hasło nie może być puste!",
          passwordLength: "Pole hasło musi mieć co najmniej 6 znaków!",
          email: "Pole email nie może być puste!",
          repeatEmail: "Pole potwierdź email nie może być puste!",
          validEmailCharacters: "Pole email musi mieć poprawny format!",
          confirmEmail: "Pole Email i Potwierdź email muszą być takie same!",
        };

        const errorSameEmails =
          email !== repeatEmail
            ? (errorRepeatEmailField.innerHTML = errorMessages.confirmEmail)
            : false;
        const errorRepeatEmail =
          repeatEmail == ""
            ? (errorRepeatEmailField.innerHTML = errorMessages.repeatEmail)
            : false;

        const errorEmailCharacters = !email.match(validEmailCharacters)
          ? (errorEmailField.innerHTML = errorMessages.validEmailCharacters)
          : false;

        const errorEmail =
          email == ""
            ? (errorEmailField.innerHTML = errorMessages.email)
            : false;
        const errorPasswordLength =
          passwordLength < 6
            ? (errorPasswordField.innerHTML = errorMessages.passwordLength)
            : false;
        const errorPassword =
          password === ""
            ? (errorPasswordField.innerHTML = errorMessages.password)
            : false;

        const errorNameCharacters = !name.match(validNameCharacters)
          ? (errorNameField.innerHTML = errorMessages.validNameCharacters)
          : false;

        const errorNameLength =
          nameLength < 6 || nameLength > 16
            ? (errorNameField.innerHTML = errorMessages.nameLength)
            : false;

        const errorName =
          name === "" ? (errorNameField.innerHTML = errorMessages.name) : false;
        // errors clear
        const ruleOfErrorNameField =
          errorNameLength ||
          (errorNameCharacters == "" && (errorNameField.innerHTML = null));
        const ruleOfErrorPasswordField =
          errorPassword ||
          (errorPasswordLength == "" && (errorPasswordField.innerHTML = null));
        const ruleOfErrorEmailField =
          errorEmail ||
          (errorEmailCharacters == "" && (errorEmailField.innerHTML = null));
        const ruleOfErrorRepeatEmailField =
          errorRepeatEmail ||
          (errorSameEmails == "" && (errorRepeatEmailField.innerHTML = null));

        const validateRules =
          errorName ||
          errorNameLength ||
          errorNameCharacters ||
          errorPassword ||
          errorPasswordLength ||
          errorEmail ||
          errorRepeatEmail ||
          errorEmailCharacters ||
          errorSameEmails;

        if (!validateRules) return true;
      }
    </script>

    <script type="text/javascript">
      function signUp(data) {
        let validate = validateFields();

        if (validate) {
          let allUsersData =
            JSON.parse(localStorage.getItem("allUsersData")) || [];
          let userExist =
            allUsersData.length &&
            JSON.parse(localStorage.getItem("allUsersData")).some(
              (data) =>
                data.name.toLowerCase() ==
                  document.getElementById("name").value.toLowerCase() ||
                data.email.toLowerCase() ==
                  document.getElementById("email").value.toLowerCase()
            );
          if (!userExist) {
            const error = document.getElementById("error");

            allUsersData = [
              {
                name: document.getElementById("name").value,
                password: document.getElementById("password").value,
                email: document.getElementById("email").value,
                repeatEmail: document.getElementById("repeatEmail").value,
              },
              ...allUsersData,
            ];
            localStorage.setItem("allUsersData", JSON.stringify(allUsersData));
            let userSignedIn = allUsersData.filter((userData) => {
              return userData.name == allUsersData[0].name;
            })[0];

            localStorage.setItem("userData_Name", userSignedIn.name);
            window.location.replace("../profilePage/profilePage.html");
            document.getElementById("name").focus();
            document.getElementById("email").focus();
          } else {
            error.innerHTML = "Konto o takiej nazwie lub emailu juz istnieje!";
          }
          data.preventDefault();
        }
      }
    </script>
  </body>
  <script>
    function goToLoginPage() {
      window.location.href = "../loginPage/loginPage.html";
    }
  </script>
</html>
